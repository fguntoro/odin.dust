<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIR models â€¢ odin.dust</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SIR models">
<meta property="og:description" content="odin.dust">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">odin.dust</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.10</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/sir_models.html">SIR models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/odin.dust/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SIR models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/odin.dust/blob/master/vignettes/sir_models.Rmd"><code>vignettes/sir_models.Rmd</code></a></small>
      <div class="hidden name"><code>sir_models.Rmd</code></div>

    </div>

    
    
<div id="stochastic-sir-model-definition" class="section level1">
<h1 class="hasAnchor">
<a href="#stochastic-sir-model-definition" class="anchor"></a>Stochastic SIR model definition</h1>
<p>A simple definition of the SIR model, as given in the <a href="https://mrc-ide.github.io/odin/articles/discrete.html">odin documentation</a> is: <span class="math display">\[\begin{align*} 
\frac{dS}{dt} &amp;= -\beta \frac{SI}{N} \\
\frac{dI}{dt} &amp;= \beta \frac{SI}{N} - \gamma I \\
\frac{dR}{dt} &amp;= \gamma I \\
\end{align*}\]</span> <span class="math inline">\(S\)</span> is the number of susceptibles, <span class="math inline">\(I\)</span> is the number of infected and <span class="math inline">\(R\)</span> is the number recovered; the total population size <span class="math inline">\(N = S + I + R\)</span> is constant. <span class="math inline">\(\beta\)</span> is the infection rate, <span class="math inline">\(\gamma\)</span> is the recovery rate.</p>
<p>Discretising this model in time steps of width <span class="math inline">\(dt\)</span> gives the following update equations for each time step:</p>
<p><span class="math display">\[\begin{align*} 
S_{t+1} &amp;= S_t - n_{SI} \\
I_{t+1} &amp;= I_t + n_{SI} - n_{IR} \\
R_{t+1} &amp;= R_t - n_{IR}
\end{align*}\]</span></p>
<p>where <span class="math display">\[\begin{align*} 
n_{SI} &amp;\sim B(S, 1 - e^{-\beta \frac{I}{N} \cdot dt}) \\
n_{IR} &amp;\sim B(I, 1 - e^{-\gamma \cdot dt})
\end{align*}\]</span></p>
<div id="implementing-the-sir-model-using-odin-dust" class="section level2">
<h2 class="hasAnchor">
<a href="#implementing-the-sir-model-using-odin-dust" class="anchor"></a>Implementing the SIR model using <a href="https://mrc-ide.github.io/odin.dust/"><code>odin.dust</code></a>
</h2>
<p>The above equations can straightforwardly be written out using the odin DSL:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co">## Definition of the time-step and output as "time"</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">step</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">dt</span>

<span class="co">## Core equations for transitions between compartments:</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op">-</span> <span class="va">n_SI</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I</span> <span class="op">+</span> <span class="va">n_SI</span> <span class="op">-</span> <span class="va">n_IR</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op">+</span> <span class="va">n_IR</span>

<span class="co">## Individual probabilities of transition:</span>
<span class="va">p_SI</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span><span class="op">)</span> <span class="co"># S to I</span>
<span class="va">p_IR</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">gamma</span><span class="op">)</span> <span class="co"># I to R</span>

<span class="co">## Draws from binomial distributions for numbers changing between</span>
<span class="co">## compartments:</span>
<span class="va">n_IR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">I</span>, <span class="va">p_IR</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span>
<span class="va">n_SI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">p_SI</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span>

<span class="co">## Total population size</span>
<span class="va">N</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op">+</span> <span class="va">I</span> <span class="op">+</span> <span class="va">R</span>

<span class="co">## Initial states:</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S_ini</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I_ini</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="co">## User defined parameters - default in parentheses:</span>
<span class="va">S_ini</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>
<span class="va">I_ini</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span>
<span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span></pre></div>
<p>This is converted to a C++ dust model, and compiled into a library in a single step, using <a href="https://mrc-ide.github.io/odin.dust/"><code>odin.dust</code></a>. Save the above code as a file named <code>sir.R</code>. File names must not contain special characters.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">library</span>(odin.dust)</a>
<a class="sourceLine" id="cb2-2" title="2">gen_sir &lt;-<span class="st"> </span>odin.dust<span class="op">::</span><span class="kw">odin_dust</span>(<span class="st">"sir.R"</span>)</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="co">#&gt; â„¹ 12 functions decorated with [[cpp11::register]]</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co">#&gt; âœ” generated file cpp11.R</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="co">#&gt; âœ” generated file cpp11.cpp</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co">#&gt; â„¹ 12 functions decorated with [[cpp11::register]]</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co">#&gt; âœ” generated file cpp11.R</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co">#&gt; âœ” generated file cpp11.cpp</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="co">#&gt; Re-compiling siree205553</span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="co">#&gt;   </span></a>
<a class="sourceLine" id="cb2-11" title="11">â”€  installing <span class="op">*</span>source<span class="op">*</span><span class="st"> </span>package â€˜siree205553â€™ ...</a>
<a class="sourceLine" id="cb2-12" title="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-13" title="13">  </a>
<a class="sourceLine" id="cb2-14" title="14">   <span class="op">**</span><span class="st"> </span>using staged installation</a>
<a class="sourceLine" id="cb2-15" title="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-16" title="16">  </a>
<a class="sourceLine" id="cb2-17" title="17">   <span class="op">**</span><span class="st"> </span>libs</a>
<a class="sourceLine" id="cb2-18" title="18"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-19" title="19">  </a>
<a class="sourceLine" id="cb2-20" title="20">   make[<span class="dv">1</span>]<span class="op">:</span><span class="st"> </span>Entering directory <span class="st">'/tmp/RtmpjGUxgO/filed3e3537e86cf/src'</span></a>
<a class="sourceLine" id="cb2-21" title="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-22" title="22">  </a>
<a class="sourceLine" id="cb2-23" title="23">   make[<span class="dv">1</span>]<span class="op">:</span><span class="st"> </span>Leaving directory <span class="st">'/tmp/RtmpjGUxgO/filed3e3537e86cf/src'</span></a>
<a class="sourceLine" id="cb2-24" title="24"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-25" title="25">  </a>
<a class="sourceLine" id="cb2-26" title="26">   make[<span class="dv">1</span>]<span class="op">:</span><span class="st"> </span>Entering directory <span class="st">'/tmp/RtmpjGUxgO/filed3e3537e86cf/src'</span></a>
<a class="sourceLine" id="cb2-27" title="27"><span class="co">#&gt;    g++ -std=gnu++11 -I"/usr/share/R/include" -DNDEBUG  -I'/home/rfitzjoh/lib/R/library/cpp11/include' -g -Wall -Wextra -pedantic -Wmaybe-uninitialized -Wno-unused-parameter -Wno-unused-variable -O2  -I/home/rfitzjoh/lib/R/library/dust/include -DHAVE_INLINE -fopenmp -fpic  -g -O2 -fdebug-prefix-map=/build/r-base-8T8CYO/r-base-4.0.3=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2 -g  -c cpp11.cpp -o cpp11.o</span></a>
<a class="sourceLine" id="cb2-28" title="28"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-29" title="29">  </a>
<a class="sourceLine" id="cb2-30" title="30">   cpp11.cpp<span class="op">:</span><span class="dv">109</span><span class="op">:</span><span class="dv">56</span><span class="op">:</span><span class="st"> </span>warning<span class="op">:</span><span class="st"> </span>cast between incompatible <span class="cf">function</span> types from â€˜SEXPREC<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)(SEXP, SEXP, SEXP, SEXP, SEXP)â€™ {aka â€˜SEXPREC<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)(SEXPREC<span class="op">*</span>, SEXPREC<span class="op">*</span>, SEXPREC<span class="op">*</span>, SEXPREC<span class="op">*</span>, SEXPREC<span class="op">*</span>)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)()â€™} [<span class="op">-</span>Wcast<span class="op">-</span><span class="cf">function</span><span class="op">-</span>type]</a>
<a class="sourceLine" id="cb2-31" title="31"><span class="co">#&gt;      109 |     {"_siree205553_dust_sir_alloc",         (DL_FUNC) &amp;_siree205553_dust_sir_alloc,         5},</span></a>
<a class="sourceLine" id="cb2-32" title="32"><span class="co">#&gt;          |                                                        ^~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb2-33" title="33"><span class="co">#&gt;    cpp11.cpp:111:56: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb2-34" title="34"><span class="co">#&gt;      111 |     {"_siree205553_dust_sir_reorder",       (DL_FUNC) &amp;_siree205553_dust_sir_reorder,       2},</span></a>
<a class="sourceLine" id="cb2-35" title="35"><span class="co">#&gt;          |                                                        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb2-36" title="36"><span class="co">#&gt;    cpp11.cpp:112:56: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb2-37" title="37"><span class="co">#&gt;      112 |     {"_siree205553_dust_sir_reset",         (DL_FUNC) &amp;_siree205553_dust_sir_reset,         3},</span></a>
<a class="sourceLine" id="cb2-38" title="38"><span class="co">#&gt;          |                                                        ^~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb2-39" title="39"><span class="co">#&gt;    cpp11.cpp:113:56: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb2-40" title="40"><span class="co">#&gt;      113 |     {"_siree205553_dust_sir_rng_state",     (DL_FUNC) &amp;_siree205553_dust_sir_rng_state,     2},</span></a>
<a class="sourceLine" id="cb2-41" title="41"><span class="co">#&gt;          |                                                        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb2-42" title="42"><span class="co">#&gt;    cpp11.cpp:114:56: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb2-43" title="43"><span class="co">#&gt;      114 |     {"_siree205553_dust_sir_run",           (DL_FUNC) &amp;_siree205553_dust_sir_run,           2},</span></a>
<a class="sourceLine" id="cb2-44" title="44"><span class="co">#&gt;        |                                                      </span></a>
<a class="sourceLine" id="cb2-45" title="45">  </a>
<a class="sourceLine" id="cb2-46" title="46">         <span class="op">|</span><span class="st">                                                        </span><span class="er">^~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb2-47" title="47"><span class="co">#&gt;    cpp11.cpp:115:56: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb2-48" title="48"><span class="co">#&gt;      115 |     {"_siree205553_dust_sir_set_index",     (DL_FUNC) &amp;_siree205553_dust_sir_set_index,     2},</span></a>
<a class="sourceLine" id="cb2-49" title="49"><span class="co">#&gt;          |                                                        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb2-50" title="50"><span class="co">#&gt;    cpp11.cpp:116:56: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb2-51" title="51"><span class="co">#&gt;      116 |     {"_siree205553_dust_sir_set_rng_state", (DL_FUNC) &amp;_siree205553_dust_sir_set_rng_state, 2},</span></a>
<a class="sourceLine" id="cb2-52" title="52"><span class="co">#&gt;          |                                                        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb2-53" title="53"><span class="co">#&gt;    cpp11.cpp:117:56: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb2-54" title="54"><span class="co">#&gt;      117 |     {"_siree205553_dust_sir_set_state",     (DL_FUNC) &amp;_siree205553_dust_sir_set_state,     3},</span></a>
<a class="sourceLine" id="cb2-55" title="55"><span class="co">#&gt;          |                                                        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb2-56" title="56"><span class="co">#&gt;    cpp11.cpp:118:56: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP, SEXP, SEXP, SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb2-57" title="57"><span class="co">#&gt;      118 |     {"_siree205553_dust_sir_simulate",      (DL_FUNC) &amp;_siree205553_dust_sir_simulate,      6},</span></a>
<a class="sourceLine" id="cb2-58" title="58"><span class="co">#&gt;          |                                                        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb2-59" title="59"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-60" title="60"><span class="st">  </span></a>
<a class="sourceLine" id="cb2-61" title="61"><span class="st">   </span>cpp11.cpp<span class="op">:</span><span class="dv">119</span><span class="op">:</span><span class="dv">56</span><span class="op">:</span><span class="st"> </span>warning<span class="op">:</span><span class="st"> </span>cast between incompatible <span class="cf">function</span> types from â€˜SEXPREC<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)(SEXP, SEXP)â€™ {aka â€˜SEXPREC<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)(SEXPREC<span class="op">*</span>, SEXPREC<span class="op">*</span>)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)()â€™} [<span class="op">-</span>Wcast<span class="op">-</span><span class="cf">function</span><span class="op">-</span>type]</a>
<a class="sourceLine" id="cb2-62" title="62"><span class="co">#&gt;      119 |     {"_siree205553_dust_sir_state",         (DL_FUNC) &amp;_siree205553_dust_sir_state,         2},</span></a>
<a class="sourceLine" id="cb2-63" title="63"><span class="co">#&gt;          |                                                        ^~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb2-64" title="64"><span class="co">#&gt;    cpp11.cpp:120:56: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb2-65" title="65"><span class="co">#&gt;      120 |     {"_siree205553_dust_sir_step",          (DL_FUNC) &amp;_siree205553_dust_sir_step,          1},</span></a>
<a class="sourceLine" id="cb2-66" title="66"><span class="co">#&gt;          |                                                        ^~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb2-67" title="67"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-68" title="68">  </a>
<a class="sourceLine" id="cb2-69" title="69">   g<span class="op">++</span><span class="st"> </span><span class="op">-</span>std=gnu<span class="op">++</span><span class="dv">11</span> <span class="op">-</span>I<span class="st">"/usr/share/R/include"</span> <span class="op">-</span>DNDEBUG  <span class="op">-</span>I<span class="st">'/home/rfitzjoh/lib/R/library/cpp11/include'</span> <span class="op">-</span>g <span class="op">-</span>Wall <span class="op">-</span>Wextra <span class="op">-</span>pedantic <span class="op">-</span>Wmaybe<span class="op">-</span>uninitialized <span class="op">-</span>Wno<span class="op">-</span>unused<span class="op">-</span>parameter <span class="op">-</span>Wno<span class="op">-</span>unused<span class="op">-</span>variable <span class="op">-</span>O2  <span class="op">-</span>I<span class="op">/</span>home<span class="op">/</span>rfitzjoh<span class="op">/</span>lib<span class="op">/</span>R<span class="op">/</span>library<span class="op">/</span>dust<span class="op">/</span>include <span class="op">-</span>DHAVE_INLINE <span class="op">-</span>fopenmp <span class="op">-</span>fpic  <span class="op">-</span>g <span class="op">-</span>O2 <span class="op">-</span>fdebug<span class="op">-</span>prefix<span class="op">-</span>map=<span class="er">/</span>build<span class="op">/</span>r<span class="op">-</span>base<span class="op">-</span>8T8CYO<span class="op">/</span>r<span class="op">-</span>base<span class="dv">-4</span>.<span class="fl">0.3</span>=. <span class="op">-</span>fstack<span class="op">-</span>protector<span class="op">-</span>strong <span class="op">-</span>Wformat <span class="op">-</span>Werror=format<span class="op">-</span>security <span class="op">-</span>Wdate<span class="op">-</span>time <span class="op">-</span>D_FORTIFY_SOURCE=<span class="dv">2</span> <span class="op">-</span>g  <span class="op">-</span>c dust.cpp <span class="op">-</span>o dust.o</a>
<a class="sourceLine" id="cb2-70" title="70"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-71" title="71">  </a>
<a class="sourceLine" id="cb2-72" title="72">   g<span class="op">++</span><span class="st"> </span><span class="op">-</span>std=gnu<span class="op">++</span><span class="dv">11</span> <span class="op">-</span>shared <span class="op">-</span>L<span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>R<span class="op">/</span>lib <span class="op">-</span>Wl,<span class="op">-</span>Bsymbolic<span class="op">-</span>functions <span class="op">-</span>Wl,<span class="op">-</span>z,relro <span class="op">-</span>o siree205553.so cpp11.o dust.o <span class="op">-</span>fopenmp <span class="op">-</span>L<span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>R<span class="op">/</span>lib <span class="op">-</span>lR</a>
<a class="sourceLine" id="cb2-73" title="73"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-74" title="74">  </a>
<a class="sourceLine" id="cb2-75" title="75">   make[<span class="dv">1</span>]<span class="op">:</span><span class="st"> </span>Leaving directory <span class="st">'/tmp/RtmpjGUxgO/filed3e3537e86cf/src'</span></a>
<a class="sourceLine" id="cb2-76" title="76"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-77" title="77">  </a>
<a class="sourceLine" id="cb2-78" title="78">   installing to <span class="op">/</span>tmp<span class="op">/</span>RtmpjGUxgO<span class="op">/</span>devtools_install_d3e3311cdc48<span class="op">/</span>00LOCK<span class="op">-</span>filed3e3537e86cf<span class="op">/</span>00new<span class="op">/</span>siree205553<span class="op">/</span>libs</a>
<a class="sourceLine" id="cb2-79" title="79"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-80" title="80">  </a>
<a class="sourceLine" id="cb2-81" title="81">   <span class="op">**</span><span class="st"> </span>checking absolute paths <span class="cf">in</span> shared objects and dynamic libraries</a>
<a class="sourceLine" id="cb2-82" title="82"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-83" title="83">  </a>
<a class="sourceLine" id="cb2-84" title="84">â”€  <span class="kw">DONE</span> (siree205553)</a>
<a class="sourceLine" id="cb2-85" title="85"><span class="co">#&gt; </span></a></code></pre></div>
</div>
<div id="adding-age-structure-to-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-age-structure-to-the-model" class="anchor"></a>Adding age structure to the model</h2>
<p>Adding age structure to the model consists of the following steps, which turn variables into arrays:</p>
<ul>
<li>Define the number of age categories as a user parameter <code>N_age</code>.</li>
<li>Add age structure to each compartment, by adding square brackets to the lvalues.</li>
<li>Modify the rvalues to use quantities from the appropriate compartment, by adding an <code>i</code> index to the rvalues. These will automatically be looped over.</li>
<li>Where an age compartment needs to be reduced into a single compartment/variable, use <code>sum</code> (or another array function from <a href="https://mrc-ide.github.io/odin/articles/functions.html" class="uri">https://mrc-ide.github.io/odin/articles/functions.html</a> as appropriate)</li>
<li>Define the dimensions of all arrays, for example by setting <code>dim(S) &lt;- N_age</code>.</li>
</ul>
<p>This would simply give <code>N_age</code> independent processes equivalent to the first model, scaled by the size of the population in each age category. To actually make this useful, you likely want to add some interaction or transitions between the compartments. An example of this would be to add an age-specific contact matrix, demonstrated below, which defines a different force of infection <span class="math inline">\(\lambda\)</span> for each age group. This is calculated by <span class="math display">\[\lambda_i = \frac{\beta}{N} \cdot \sum_{j=1}^{N_{\mathrm{age}}} I_j m_{ij}\]</span> In the odin code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">m</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span> <span class="co"># age-structured contact matrix</span>
<span class="va">s_ij</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="va">I</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="va">lambda</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">beta</span> <span class="op">/</span> <span class="va">N</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">s_ij</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span></pre></div>
<p>The probability of infection of a susceptible is then indexed by this force of infection:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">p_SI</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span></pre></div>
<p>Putting this all together, the age structured SIR model is as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co">## Definition of the time-step and output as "time"</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">step</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">dt</span>

<span class="co">## Core equations for transitions between compartments:</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">n_SI</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">I</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">n_SI</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">n_IR</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">R</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">R</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">n_IR</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>

<span class="co">## Individual probabilities of transition:</span>
<span class="va">p_SI</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span> <span class="co"># S to I</span>
<span class="va">p_IR</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span> <span class="co"># I to R</span>

<span class="co">## Force of infection</span>
<span class="va">m</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span> <span class="co"># age-structured contact matrix</span>
<span class="va">s_ij</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="va">I</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="va">lambda</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">beta</span> <span class="op">/</span> <span class="va">N</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">s_ij</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span>

<span class="co">## Draws from binomial distributions for numbers changing between</span>
<span class="co">## compartments:</span>
<span class="va">n_SI</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">p_SI</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
<span class="va">n_IR</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">I</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">p_IR</span><span class="op">)</span>

<span class="co">## Total population size</span>
<span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span>

<span class="co">## Initial states:</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S_ini</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">I</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I_ini</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">R</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="co">## User defined parameters - default in parentheses:</span>
<span class="va">S_ini</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>
<span class="va">I_ini</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span>
<span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>

<span class="co"># dimensions of arrays</span>
<span class="va">N_age</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">n_SI</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">n_IR</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">p_SI</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">N_age</span>, <span class="va">N_age</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">s_ij</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">N_age</span>, <span class="va">N_age</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span></pre></div>
<p>As before, save the file, and use <code>odin.dust</code> to compile the model:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">gen_age &lt;-<span class="st"> </span>odin.dust<span class="op">::</span><span class="kw">odin_dust</span>(<span class="st">"sirage.R"</span>)</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co">#&gt; â„¹ 12 functions decorated with [[cpp11::register]]</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">#&gt; âœ” generated file cpp11.R</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co">#&gt; âœ” generated file cpp11.cpp</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="co">#&gt; â„¹ 12 functions decorated with [[cpp11::register]]</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">#&gt; âœ” generated file cpp11.R</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co">#&gt; âœ” generated file cpp11.cpp</span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">#&gt; Re-compiling siragebf22a6a2</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="co">#&gt;   </span></a>
<a class="sourceLine" id="cb6-10" title="10">â”€  installing <span class="op">*</span>source<span class="op">*</span><span class="st"> </span>package â€˜siragebf22a6a2â€™ ...</a>
<a class="sourceLine" id="cb6-11" title="11"><span class="co">#&gt;    ** using staged installation</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-13" title="13">  </a>
<a class="sourceLine" id="cb6-14" title="14">   <span class="op">**</span><span class="st"> </span>libs</a>
<a class="sourceLine" id="cb6-15" title="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-16" title="16">  </a>
<a class="sourceLine" id="cb6-17" title="17">   make[<span class="dv">1</span>]<span class="op">:</span><span class="st"> </span>Entering directory <span class="st">'/tmp/RtmpjGUxgO/filed3e3ec7ef5d/src'</span></a>
<a class="sourceLine" id="cb6-18" title="18"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-19" title="19">  </a>
<a class="sourceLine" id="cb6-20" title="20">   make[<span class="dv">1</span>]<span class="op">:</span><span class="st"> </span>Leaving directory <span class="st">'/tmp/RtmpjGUxgO/filed3e3ec7ef5d/src'</span></a>
<a class="sourceLine" id="cb6-21" title="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-22" title="22">  </a>
<a class="sourceLine" id="cb6-23" title="23">   make[<span class="dv">1</span>]<span class="op">:</span><span class="st"> </span>Entering directory <span class="st">'/tmp/RtmpjGUxgO/filed3e3ec7ef5d/src'</span></a>
<a class="sourceLine" id="cb6-24" title="24"><span class="co">#&gt;    g++ -std=gnu++11 -I"/usr/share/R/include" -DNDEBUG  -I'/home/rfitzjoh/lib/R/library/cpp11/include' -g -Wall -Wextra -pedantic -Wmaybe-uninitialized -Wno-unused-parameter -Wno-unused-variable -O2  -I/home/rfitzjoh/lib/R/library/dust/include -DHAVE_INLINE -fopenmp -fpic  -g -O2 -fdebug-prefix-map=/build/r-base-8T8CYO/r-base-4.0.3=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2 -g  -c cpp11.cpp -o cpp11.o</span></a>
<a class="sourceLine" id="cb6-25" title="25"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-26" title="26">  </a>
<a class="sourceLine" id="cb6-27" title="27">   cpp11.cpp<span class="op">:</span><span class="dv">109</span><span class="op">:</span><span class="dv">62</span><span class="op">:</span><span class="st"> </span>warning<span class="op">:</span><span class="st"> </span>cast between incompatible <span class="cf">function</span> types from â€˜SEXPREC<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)(SEXP, SEXP, SEXP, SEXP, SEXP)â€™ {aka â€˜SEXPREC<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)(SEXPREC<span class="op">*</span>, SEXPREC<span class="op">*</span>, SEXPREC<span class="op">*</span>, SEXPREC<span class="op">*</span>, SEXPREC<span class="op">*</span>)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)()â€™} [<span class="op">-</span>Wcast<span class="op">-</span><span class="cf">function</span><span class="op">-</span>type]</a>
<a class="sourceLine" id="cb6-28" title="28"><span class="co">#&gt;      109 |     {"_siragebf22a6a2_dust_sirage_alloc",         (DL_FUNC) &amp;_siragebf22a6a2_dust_sirage_alloc,         5},</span></a>
<a class="sourceLine" id="cb6-29" title="29"><span class="co">#&gt;          |                                                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb6-30" title="30"><span class="co">#&gt;    cpp11.cpp:111:62: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb6-31" title="31"><span class="co">#&gt;      111 |     {"_siragebf22a6a2_dust_sirage_reorder",       (DL_FUNC) &amp;_siragebf22a6a2_dust_sirage_reorder,       2},</span></a>
<a class="sourceLine" id="cb6-32" title="32"><span class="co">#&gt;          |                                                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb6-33" title="33"><span class="co">#&gt;    cpp11.cpp:112:62: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb6-34" title="34"><span class="co">#&gt;      112 |     {"_siragebf22a6a2_dust_sirage_reset",         (DL_FUNC) &amp;_siragebf22a6a2_dust_sirage_reset,         3},</span></a>
<a class="sourceLine" id="cb6-35" title="35"><span class="co">#&gt;          |                                                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb6-36" title="36"><span class="co">#&gt;    cpp11.cpp:113:62: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb6-37" title="37"><span class="co">#&gt;      113 |     {"_siragebf22a6a2_dust_sirage_rng_state",     (DL_FUNC) &amp;_siragebf22a6a2_dust_sirage_rng_state,     2},</span></a>
<a class="sourceLine" id="cb6-38" title="38"><span class="co">#&gt;          |                                                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb6-39" title="39"><span class="co">#&gt;    cpp11.cpp:114:62: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb6-40" title="40"><span class="co">#&gt;    114 |     {"_siragebf22a6a2_dust_sirage_run",           (DL_FUNC) &amp;</span></a>
<a class="sourceLine" id="cb6-41" title="41">  </a>
<a class="sourceLine" id="cb6-42" title="42">     <span class="dv">114</span> <span class="op">|</span><span class="st">     </span>{<span class="st">"_siragebf22a6a2_dust_sirage_run"</span>,           (DL_FUNC) <span class="op">&amp;</span>_siragebf22a6a2_dust_sirage_run,           <span class="dv">2</span>},</a>
<a class="sourceLine" id="cb6-43" title="43"><span class="co">#&gt;          |                                                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb6-44" title="44"><span class="co">#&gt;    cpp11.cpp:115:62: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb6-45" title="45"><span class="co">#&gt;      115 |     {"_siragebf22a6a2_dust_sirage_set_index",     (DL_FUNC) &amp;_siragebf22a6a2_dust_sirage_set_index,     2},</span></a>
<a class="sourceLine" id="cb6-46" title="46"><span class="co">#&gt;          |                                                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb6-47" title="47"><span class="co">#&gt;    cpp11.cpp:116:62: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb6-48" title="48"><span class="co">#&gt;      116 |     {"_siragebf22a6a2_dust_sirage_set_rng_state", (DL_FUNC) &amp;_siragebf22a6a2_dust_sirage_set_rng_state, 2},</span></a>
<a class="sourceLine" id="cb6-49" title="49"><span class="co">#&gt;          |                                                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb6-50" title="50"><span class="co">#&gt;    cpp11.cpp:117:62: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb6-51" title="51"><span class="co">#&gt;      117 |     {"_siragebf22a6a2_dust_sirage_set_state",     (DL_FUNC) &amp;_siragebf22a6a2_dust_sirage_set_state,     3},</span></a>
<a class="sourceLine" id="cb6-52" title="52"><span class="co">#&gt;          |                                                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb6-53" title="53"><span class="co">#&gt;    cpp11.cpp:118:62: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SEXP, SEXP, SEXP, SEXP, SEXP, SEXP)â€™ {aka â€˜SEXPREC* (*)(SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*, SEXPREC*)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void* (*)()â€™} [-Wcast-function-type]</span></a>
<a class="sourceLine" id="cb6-54" title="54"><span class="co">#&gt;      118 |     {"_siragebf22a6a2_dust_sirage_simulate",      (DL_FUNC) &amp;_siragebf22a6a2_dust_sirage_simulate,      6},</span></a>
<a class="sourceLine" id="cb6-55" title="55"><span class="co">#&gt;          |                                                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb6-56" title="56"><span class="co">#&gt; cpp11.cpp:119:62: warning: cast between incompatible function types from â€˜SEXPREC* (*)(SE</span></a>
<a class="sourceLine" id="cb6-57" title="57">  </a>
<a class="sourceLine" id="cb6-58" title="58">   cpp11.cpp<span class="op">:</span><span class="dv">119</span><span class="op">:</span><span class="dv">62</span><span class="op">:</span><span class="st"> </span>warning<span class="op">:</span><span class="st"> </span>cast between incompatible <span class="cf">function</span> types from â€˜SEXPREC<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)(SEXP, SEXP)â€™ {aka â€˜SEXPREC<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)(SEXPREC<span class="op">*</span>, SEXPREC<span class="op">*</span>)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)()â€™} [<span class="op">-</span>Wcast<span class="op">-</span><span class="cf">function</span><span class="op">-</span>type]</a>
<a class="sourceLine" id="cb6-59" title="59"><span class="co">#&gt;      119 |     {"_siragebf22a6a2_dust_sirage_state",         (DL_FUNC) &amp;_siragebf22a6a2_dust_sirage_state,         2},</span></a>
<a class="sourceLine" id="cb6-60" title="60"><span class="co">#&gt;          |                                                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb6-61" title="61"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-62" title="62">  </a>
<a class="sourceLine" id="cb6-63" title="63">   cpp11.cpp<span class="op">:</span><span class="dv">120</span><span class="op">:</span><span class="dv">62</span><span class="op">:</span><span class="st"> </span>warning<span class="op">:</span><span class="st"> </span>cast between incompatible <span class="cf">function</span> types from â€˜SEXPREC<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)(SEXP)â€™ {aka â€˜SEXPREC<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)(SEXPREC<span class="op">*</span>)â€™} to â€˜DL_FUNCâ€™ {aka â€˜void<span class="op">*</span><span class="st"> </span>(<span class="op">*</span>)()â€™} [<span class="op">-</span>Wcast<span class="op">-</span><span class="cf">function</span><span class="op">-</span>type]</a>
<a class="sourceLine" id="cb6-64" title="64"><span class="co">#&gt;      120 |     {"_siragebf22a6a2_dust_sirage_step",          (DL_FUNC) &amp;_siragebf22a6a2_dust_sirage_step,          1},</span></a>
<a class="sourceLine" id="cb6-65" title="65"><span class="co">#&gt;          |                                                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></a>
<a class="sourceLine" id="cb6-66" title="66"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-67" title="67">  </a>
<a class="sourceLine" id="cb6-68" title="68">   g<span class="op">++</span><span class="st"> </span><span class="op">-</span>std=gnu<span class="op">++</span><span class="dv">11</span> <span class="op">-</span>I<span class="st">"/usr/share/R/include"</span> <span class="op">-</span>DNDEBUG  <span class="op">-</span>I<span class="st">'/home/rfitzjoh/lib/R/library/cpp11/include'</span> <span class="op">-</span>g <span class="op">-</span>Wall <span class="op">-</span>Wextra <span class="op">-</span>pedantic <span class="op">-</span>Wmaybe<span class="op">-</span>uninitialized <span class="op">-</span>Wno<span class="op">-</span>unused<span class="op">-</span>parameter <span class="op">-</span>Wno<span class="op">-</span>unused<span class="op">-</span>variable <span class="op">-</span>O2  <span class="op">-</span>I<span class="op">/</span>home<span class="op">/</span>rfitzjoh<span class="op">/</span>lib<span class="op">/</span>R<span class="op">/</span>library<span class="op">/</span>dust<span class="op">/</span>include <span class="op">-</span>DHAVE_INLINE <span class="op">-</span>fopenmp <span class="op">-</span>fpic  <span class="op">-</span>g <span class="op">-</span>O2 <span class="op">-</span>fdebug<span class="op">-</span>prefix<span class="op">-</span>map=<span class="er">/</span>build<span class="op">/</span>r<span class="op">-</span>base<span class="op">-</span>8T8CYO<span class="op">/</span>r<span class="op">-</span>base<span class="dv">-4</span>.<span class="fl">0.3</span>=. <span class="op">-</span>fstack<span class="op">-</span>protector<span class="op">-</span>strong <span class="op">-</span>Wformat <span class="op">-</span>Werror=format<span class="op">-</span>security <span class="op">-</span>Wdate<span class="op">-</span>time <span class="op">-</span>D_FORTIFY_SOURCE=<span class="dv">2</span> <span class="op">-</span>g  <span class="op">-</span>c dust.cpp <span class="op">-</span>o dust.o</a>
<a class="sourceLine" id="cb6-69" title="69"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-70" title="70">  </a>
<a class="sourceLine" id="cb6-71" title="71">   g<span class="op">++</span><span class="st"> </span><span class="op">-</span>std=gnu<span class="op">++</span><span class="dv">11</span> <span class="op">-</span>shared <span class="op">-</span>L<span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>R<span class="op">/</span>lib <span class="op">-</span>Wl,<span class="op">-</span>Bsymbolic<span class="op">-</span>functions <span class="op">-</span>Wl,<span class="op">-</span>z,relro <span class="op">-</span>o siragebf22a6a2.so cpp11.o dust.o <span class="op">-</span>fopenmp <span class="op">-</span>L<span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>R<span class="op">/</span>lib <span class="op">-</span>lR</a>
<a class="sourceLine" id="cb6-72" title="72"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-73" title="73">  </a>
<a class="sourceLine" id="cb6-74" title="74">   make[<span class="dv">1</span>]<span class="op">:</span><span class="st"> </span>Leaving directory <span class="st">'/tmp/RtmpjGUxgO/filed3e3ec7ef5d/src'</span></a>
<a class="sourceLine" id="cb6-75" title="75"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-76" title="76">  </a>
<a class="sourceLine" id="cb6-77" title="77">   installing to <span class="op">/</span>tmp<span class="op">/</span>RtmpjGUxgO<span class="op">/</span>devtools_install_d3e36fe020ae<span class="op">/</span>00LOCK<span class="op">-</span>filed3e3ec7ef5d<span class="op">/</span>00new<span class="op">/</span>siragebf22a6a2<span class="op">/</span>libs</a>
<a class="sourceLine" id="cb6-78" title="78"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-79" title="79">  </a>
<a class="sourceLine" id="cb6-80" title="80">   <span class="op">**</span><span class="st"> </span>checking absolute paths <span class="cf">in</span> shared objects and dynamic libraries</a>
<a class="sourceLine" id="cb6-81" title="81"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-82" title="82">  </a>
<a class="sourceLine" id="cb6-83" title="83">â”€  <span class="kw">DONE</span> (siragebf22a6a2)</a>
<a class="sourceLine" id="cb6-84" title="84"><span class="co">#&gt; </span></a></code></pre></div>
<p>We can generate an age-structured contact matrix based on the <a href="https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.0050074">POLYMOD</a> survey by using the <a href="https://github.com/sbfnk/socialmixr">socialmixr</a> package:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">polymod</span>, package <span class="op">=</span> <span class="st">"socialmixr"</span><span class="op">)</span>

<span class="va">age.limits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">70</span>, <span class="fl">10</span><span class="op">)</span>

<span class="co">## Get the contact matrix from socialmixr</span>
<span class="va">contact</span> <span class="op">&lt;-</span> <span class="fu">socialmixr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/socialmixr/man/contact_matrix.html">contact_matrix</a></span><span class="op">(</span>
  survey <span class="op">=</span> <span class="va">polymod</span>,
  countries <span class="op">=</span> <span class="st">"United Kingdom"</span>,
  age.limits <span class="op">=</span> <span class="va">age.limits</span>,
  symmetric <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Using POLYMOD social contact data. To cite this in a publication, use the 'cite' function</span>
<span class="co">#&gt; Removing participants that have contacts without age information. To change this behaviour, set the 'missing.contact.age' option</span>

<span class="co">## Transform the matrix to the (symetrical) transmission matrix</span>
<span class="co">## rather than the contact matrix</span>
<span class="va">transmission</span> <span class="op">&lt;-</span> <span class="va">contact</span><span class="op">$</span><span class="va">matrix</span> <span class="op">/</span>
  <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">contact</span><span class="op">$</span><span class="va">demography</span><span class="op">$</span><span class="va">population</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">contact</span><span class="op">$</span><span class="va">matrix</span><span class="op">)</span><span class="op">)</span>
<span class="va">transmission</span>
<span class="co">#&gt;       contact.age.group</span>
<span class="co">#&gt;              [0,10)      [10,20)      [20,30)      [30,40)      [40,50)</span>
<span class="co">#&gt;   [1,] 7.351697e-07 1.681349e-07 1.623038e-07 2.523168e-07 1.257326e-07</span>
<span class="co">#&gt;   [2,] 1.681349e-07 1.036281e-06 1.692542e-07 1.697777e-07 2.181730e-07</span>
<span class="co">#&gt;   [3,] 1.623038e-07 1.692542e-07 4.704750e-07 2.056299e-07 2.070420e-07</span>
<span class="co">#&gt;   [4,] 2.523168e-07 1.697777e-07 2.056299e-07 3.117035e-07 2.231807e-07</span>
<span class="co">#&gt;   [5,] 1.257326e-07 2.181730e-07 2.070420e-07 2.231807e-07 3.354107e-07</span>
<span class="co">#&gt;   [6,] 8.037308e-08 1.039198e-07 1.799980e-07 1.678511e-07 1.757299e-07</span>
<span class="co">#&gt;   [7,] 8.154532e-08 6.991192e-08 1.165298e-07 1.498801e-07 1.457821e-07</span>
<span class="co">#&gt;   [8,] 2.994231e-08 7.542364e-08 5.972715e-08 4.640225e-08 1.250247e-07</span>
<span class="co">#&gt;       contact.age.group</span>
<span class="co">#&gt;             [50,60)      [60,70)          70+</span>
<span class="co">#&gt;   [1,] 8.037308e-08 8.154532e-08 2.994231e-08</span>
<span class="co">#&gt;   [2,] 1.039198e-07 6.991192e-08 7.542364e-08</span>
<span class="co">#&gt;   [3,] 1.799980e-07 1.165298e-07 5.972715e-08</span>
<span class="co">#&gt;   [4,] 1.678511e-07 1.498801e-07 4.640225e-08</span>
<span class="co">#&gt;   [5,] 1.757299e-07 1.457821e-07 1.250247e-07</span>
<span class="co">#&gt;   [6,] 2.473517e-07 1.652266e-07 1.076856e-07</span>
<span class="co">#&gt;   [7,] 1.652266e-07 2.010654e-07 1.431130e-07</span>
<span class="co">#&gt;   [8,] 1.076856e-07 1.431130e-07 1.941792e-07</span></pre></div>
<p>This can be given as a parameter to the model by adding the argument <code>data = list(m = transmission)</code> when using the <code>new()</code> method on the <code>gen_age</code> generator.</p>
</div>
<div id="saving-a-model-into-a-package" class="section level2">
<h2 class="hasAnchor">
<a href="#saving-a-model-into-a-package" class="anchor"></a>Saving a model into a package</h2>
<p>If you want to distribute your model in an R package, rather than building it locally, you will want to use the <code><a href="../reference/odin_dust_package.html">odin_dust_package()</a></code> function instead. This will write the transpiled C++ dust code into <code>src</code> and its R interface in <code>R/dust.R</code>. Package users are not required to regenerate the dust code, and their compiler will build the library when they install the package. You may also wish to add a file <code>R/zzz.R</code> to your package <code>myrpackage</code> with the following lines:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="co">##' @useDynLib myrpackage, .registration = TRUE</span>
<span class="cn">NULL</span></pre></div>
<p>to help automate the compilation of the model.</p>
</div>
</div>
<div id="running-the-sir-model-with-dust" class="section level1">
<h1 class="hasAnchor">
<a href="#running-the-sir-model-with-dust" class="anchor"></a>Running the SIR model with <a href="https://mrc-ide.github.io/dust/"><code>dust</code></a>
</h1>
<p>Now we can use the <code>new</code> method on the generator to make <code>dust</code> objects. <code>dust</code> can be driven directly from R, and also interfaces with the <a href="https://mrc-ide.github.io/mcstate/"><code>mcstate</code></a> package to allow parameter inference and forecasting.</p>
<p><a href="https://mrc-ide.github.io/dust/reference/dust.html#method-new"><code>new()</code></a> takes the data needed to run the model i.e.Â a list with any parameters defined as <code>user</code> in the odin code above, the value of the initial step <span class="math inline">\(t_0\)</span>, and the number of particles, each for now can simply be thought of as an independent stochastic realisation of the model, but in the next step will be used when inferring model parameters.</p>
<p>Additional arguments include the number of threads to parallelise the particles over, and the seed for the random number generator. The seed must be an integer, and using the same seed will ensure reproducible results for all particles. To use this to directly create a new dust object with 10 particles, run using 4 threads:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">sir_model</span> <span class="op">&lt;-</span> <span class="va">gen_sir</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="fl">1</span>, 
                                     S_ini <span class="op">=</span> <span class="fl">1000</span>, 
                                     I_ini <span class="op">=</span> <span class="fl">10</span>, 
                                     beta <span class="op">=</span> <span class="fl">0.2</span>, 
                                     gamma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,
                         step <span class="op">=</span> <span class="fl">1</span>,
                         n_particles <span class="op">=</span> <span class="fl">10L</span>,
                         n_threads <span class="op">=</span> <span class="fl">4L</span>,
                         seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></pre></div>
<p>The initial state is ten particles wide, four states deep (<span class="math inline">\(t\)</span>, <span class="math inline">\(S\)</span>, <span class="math inline">\(I\)</span>, <span class="math inline">\(R\)</span>):</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">sir_model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span>
<span class="co">#&gt; [1,]    0    0    0    0    0    0    0    0    0     0</span>
<span class="co">#&gt; [2,] 1000 1000 1000 1000 1000 1000 1000 1000 1000  1000</span>
<span class="co">#&gt; [3,]   10   10   10   10   10   10   10   10   10    10</span>
<span class="co">#&gt; [4,]    0    0    0    0    0    0    0    0    0     0</span></pre></div>
<p>Run the particles (repeats) forward 10 steps of length <span class="math inline">\(dt\)</span>, followed by another 10 steps:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="va">sir_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span>
<span class="co">#&gt; [1,]   10   10   10   10   10   10   10   10   10    10</span>
<span class="co">#&gt; [2,]  978  966  986  982  980  980  971  974  968   984</span>
<span class="co">#&gt; [3,]   16   28   10   16   21   15   25   26   24    15</span>
<span class="co">#&gt; [4,]   16   16   14   12    9   15   14   10   18    11</span>
<span class="va">sir_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>
<span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span>
<span class="co">#&gt; [1,]   20   20   20   20   20   20   20   20   20    20</span>
<span class="co">#&gt; [2,]  943  889  946  933  906  929  853  909  922   932</span>
<span class="co">#&gt; [3,]   30   66   44   39   61   42   97   53   41    41</span>
<span class="co">#&gt; [4,]   37   55   20   38   43   39   60   48   47    37</span></pre></div>
<p>We can change the parameters, say by increasing the infection rate and the population size, by reinitalising the model with <code>reset()</code>. We will also use a smaller time step to calculate multiple transitions per unit time:</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="va">dt</span> <span class="op">=</span> <span class="fl">0.25</span>
<span class="va">n_particles</span> <span class="op">&lt;-</span> <span class="fl">10L</span>
<span class="va">sir_model</span><span class="op">$</span><span class="fu">reset</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="fl">0.25</span>, 
                            S_ini <span class="op">=</span> <span class="fl">2000</span>, 
                            I_ini <span class="op">=</span> <span class="fl">10</span>, 
                            beta <span class="op">=</span> <span class="fl">0.4</span>, 
                            gamma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,
                step <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">sir_model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span>
<span class="co">#&gt; [1,]    0    0    0    0    0    0    0    0    0     0</span>
<span class="co">#&gt; [2,] 2000 2000 2000 2000 2000 2000 2000 2000 2000  2000</span>
<span class="co">#&gt; [3,]   10   10   10   10   10   10   10   10   10    10</span>
<span class="co">#&gt; [4,]    0    0    0    0    0    0    0    0    0     0</span></pre></div>
<p>Letâ€™s run this epidemic forward, and plot the trajectories:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="va">n_steps</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sir_model</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">len</span>, <span class="va">n_particles</span>, <span class="va">n_steps</span><span class="op">)</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n_steps</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span><span class="op">[</span> , , <span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sir_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">time</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="op">]</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, , <span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.1</span>, <span class="fl">5.1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="st">"#8c8cd9"</span>, I <span class="op">=</span> <span class="st">"#cc0044"</span>, R <span class="op">=</span> <span class="st">"#999966"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span>, , <span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>,
         xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Number of individuals"</span>,
         col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"S"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span>, , <span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"I"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span>, , <span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"R"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"left"</span>, lwd <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">cols</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></pre></div>
<p><img src="sir_models_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>Many other methods are available on the dust object to support inference, but typically you may want to use the <a href="https://mrc-ide.github.io/mcstate/"><code>mcstate</code></a> package instead of calling these directly. However, if you wish to simulate state space models with set parameters, this can be done entirely using the commands above from <a href="https://mrc-ide.github.io/dust/"><code>dust</code></a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rich FitzJohn, John Lees.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
